<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icons/logo2.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/logo2.png">
    <link rel="shortcut icon" href="icons/logo2.png" type="image/x-icon">
    <title>Sala de Trofeos Cósmicos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --space-dark: #0f0c29; --space-mid: #302b63; --space-light: #24243e;
            --text-light: #e0e6f0; --accent-glow: #00ffff; --success-glow: #7CFC00;
            --fail-glow: #ff4b4b; --gold-glow: #ffd700;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Baloo 2', cursive; background-color: var(--space-dark);
            margin: 0; color: var(--text-light); padding: 40px 20px;
            position: relative; z-index: 1;
        }
        #starry-background, #image-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        #image-overlay { background-image: url('icons/fondo.png'); background-size: cover; background-position: center; opacity: 0.1; z-index: -1; }
        #starry-background {
            background-image: 
                radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px; animation: twinkle 10s infinite linear;
        }
        @keyframes twinkle { from { background-position: 0 0; } to { background-position: -400px -400px; } }
        .menu-button {
            position: fixed; top: 20px; right: 30px; display: flex;
            align-items: center; gap: 10px; padding: 10px 20px;
            background: var(--gold-glow); border: 2px solid var(--gold-glow);
            border-radius: 50px; color: var(--space-dark); text-decoration: none;
            font-family: 'Orbitron', sans-serif; font-weight: bold;
            transition: all 0.3s ease; z-index: 1001;
        }
        .menu-button:hover {
            background-color: var(--accent-glow); border-color: var(--accent-glow);
            box-shadow: 0 0 25px var(--accent-glow); transform: translateY(-3px) scale(1.05);
        }
        .menu-button .fa-rocket { transform: rotate(-45deg); }
        .container {
            width: 100%; max-width: 900px; margin: 50px auto 10px;
            background: linear-gradient(145deg, var(--space-mid), var(--space-light));
            padding: 20px; border-radius: 20px; text-align: center;
            border: 2px solid var(--accent-glow); box-shadow: 0 0 25px rgba(0, 255, 255, 0.3);
        }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--accent-glow); text-shadow: 0 0 15px var(--accent-glow); margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card {
            background-color: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        .stat-card h3 { display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-light); margin-bottom: 10px; font-size: 1.1rem; }
        .stat-card .value { font-size: 2.5rem; font-weight: bold; color: var(--accent-glow); }
        .xp-bar-container { background-color: rgba(0,0,0,0.3); border-radius: 10px; padding: 5px; margin-top: 10px; }
        .xp-bar { width: 0%; height: 15px; background: linear-gradient(90deg, var(--gold-glow), var(--accent-glow)); border-radius: 5px; transition: width 1s ease-out; }
        .action-button {
            padding: 15px 40px; background-color: var(--success-glow); color: var(--space-dark);
            border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: all 0.3s;
        }
        .action-button:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--success-glow); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 1000; padding: 20px; overflow-y: auto;
        }
        .certificate-wrapper { animation: descend 0.8s cubic-bezier(0.25, 1, 0.5, 1); position: relative; margin: 20px 0; }
        @keyframes descend { from { transform: translateY(-50vh) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        #certificate {
            background-color: #fffaf0; color: #333;
            border: 10px solid; border-image-slice: 1;
            border-image-source: linear-gradient(to bottom right, var(--gold-glow), var(--accent-glow));
            padding: 40px; text-align: center; width: 100%; max-width: 700px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }
        .cert-logos { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cert-logos img { max-height: 60px; }
        #certificate h2 { font-family: 'Orbitron', sans-serif; color: #2c3e50; font-size: 2.2rem; text-transform: uppercase; margin-bottom: 20px; }
        #certificate p { margin: 10px 0; font-size: 1.1rem; }
        #certificate .name {
            font-family: 'Baloo 2', cursive; font-size: 2rem; font-weight: bold;
            color: #d35400; border-bottom: 2px dashed #d35400; display: inline-block; padding-bottom: 5px;
            margin: 15px 0;
        }
        #certificate .level { font-size: 1.5rem; color: #2980b9; font-weight: bold; }
        .cert-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-top: 30px; 
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        }
        .cert-footer .date { font-style: italic; color: #666; font-size: 0.9rem;}
        .cert-footer .seal { font-size: 4rem; color: var(--gold-glow); text-shadow: 1px 1px 5px rgba(0,0,0,0.3); }

        /* Estilos para la firma de EduConnectRuben */
        .cert-signature {
            width: 100%; /* Ocupa todo el ancho disponible */
            margin-top: 40px; /* Espacio significativo por encima de la firma */
            text-align: center; /* Centra el contenido */
            display: flex; /* Usa flexbox para alinear la línea y el texto */
            flex-direction: column; /* Apila la línea y el texto verticalmente */
            align-items: center; /* Centra los elementos horizontalmente */
        }
        .cert-signature .signature-line {
            display: block; /* Asegura que la línea sea un bloque */
            width: 70%; /* Ancho de la línea de la firma */
            margin-bottom: 5px; /* Pequeño espacio entre la línea y el texto */
            border-bottom: 1px solid #333; /* La línea de la firma */
        }
        .cert-signature .signature-text {
            font-family: 'Orbitron', sans-serif; /* Un estilo de fuente distintivo para la firma */
            font-weight: bold;
            color: #2c3e50; /* Color oscuro para un buen contraste */
            font-size: 1.1rem; /* Tamaño de fuente de la firma */
        }

        .modal-buttons { margin-top: 20px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .hidden { display: none; }
        @media (max-width: 768px) {
            .container { padding: 20px; margin-top: 80px; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            #certificate { padding: 20px; }
            #certificate h2 { font-size: 1.5rem; }
            #certificate .name { font-size: 1.5rem; }
            .menu-button { padding: 8px 15px; font-size: 0.9rem; gap: 5px; }
            /* Ajustes para la firma en móviles si es necesario */
            .cert-signature { margin-top: 30px; }
            .cert-signature .signature-line { width: 80%; } /* Ajustar ancho de línea en móviles */
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .stat-card .value { font-size: 1.1rem;padding: 3px; }
            .cert-logos img { max-height: 35px; }
            #certificate h2 { font-size: 1.2rem; }
            #certificate p { font-size: 1rem; }
            #certificate .name { font-size: 1.2rem; }
            .cert-footer .seal { font-size: 3rem; }
            .menu-button { top: 15px; right: 15px; }
        }
    </style>
</head>
<body>
    <div id="starry-background"></div>
    <div id="image-overlay"></div>
    <a href="index.html" class="menu-button"><span>MENÚ PRINCIPAL</span><i class="fas fa-rocket"></i></a>
    <div class="container">
        <h1>SALA DE TROFEOS CÓSMICOS</h1>
        <div class="stats">
            <div class="stat-card"><h3><i class="fas fa-bullseye"></i> Aciertos</h3><div class="value" id="correct-answers">0</div></div>
            <div class="stat-card"><h3><i class="fas fa-question-circle"></i> Preguntas</h3><div class="value" id="total-questions">0</div></div>
            <div class="stat-card"><h3><i class="fas fa-chart-line"></i> Precisión</h3><div class="value" id="success-rate">0%</div></div>
            <div class="stat-card"><h3><i class="fas fa-rocket"></i> Rango</h3><div class="value" id="current-level">Cadete</div><div class="xp-bar-container"><div id="xp-bar" class="xp-bar"></div></div></div>
        </div>
        <button id="generate-certificate-btn" class="action-button">GENERAR CERTIFICADO</button>
    </div>
    <div id="certificate-modal" class="modal-overlay hidden">
        <div class="certificate-wrapper">
            <div id="certificate">
                <div class="cert-logos">
                    <img id="logo-ue-cert" src="icons/logoUE.png" alt="Logo UE">
                    <img id="logo-ecr-cert" src="icons/logoECR.png" alt="Logo ECR">
                </div>
                <h2>Certificado de Logro</h2>
                <p>EduConnectRuben otorga el siguiente certificado a:</p><div id="certificate-name" class="name"></div>
                <p>por demostrar una habilidad excepcional en el</p><p><strong>Duelo Cósmico de Multiplicaciones</strong></p>
                <p>alcanzando el prestigioso rango de:</p><div id="certificate-level" class="level"></div>
                <div class="cert-footer"><div id="certificate-date" class="date"></div><div class="seal">🏆</div></div>
                
                <div class="cert-signature">
                    <span class="signature-line"></span>
                    <span class="signature-text">EduConnectRuben</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="download-certificate-btn" class="action-button">Descargar</button>
                <button id="close-certificate-btn" class="action-button" style="background-color: var(--fail-glow);">Cerrar</button>
            </div>
        </div>
    </div>
    <audio id="sound-win" src="sound/aprobado.mp3" preload="auto"></audio>
    <audio id="sound-prize" src="sound/premio.mp3" preload="auto"></audio>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="progress-manager.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const correctEl = document.getElementById('correct-answers');
        const totalEl = document.getElementById('total-questions');
        const rateEl = document.getElementById('success-rate');
        const levelEl = document.getElementById('current-level');
        const xpBar = document.getElementById('xp-bar');
        const generateBtn = document.getElementById('generate-certificate-btn');
        const certificateModal = document.getElementById('certificate-modal');
        const certNameEl = document.getElementById('certificate-name');
        const certLevelEl = document.getElementById('certificate-level');
        const certDateEl = document.getElementById('certificate-date');
        const downloadBtn = document.getElementById('download-certificate-btn');
        const closeBtn = document.getElementById('close-certificate-btn');
        const sounds = { win: document.getElementById('sound-win'), prize: document.getElementById('sound-prize'), };
        const ranks = [
            { name: "Cadete Estelar", minScore: 0 }, { name: "Piloto Habilidoso", minScore: 200 },
            { name: "Comandante Estelar", minScore: 500 }, { name: "Leyenda Cósmica", minScore: 1000 }
        ];
        
        function loadProgress() {
            const progress = getProgress();
            const totalScore = progress.totalScore;
            const correctAnswers = progress.correctAnswers;
            const totalQuestions = progress.totalQuestions;
            animateValue(correctEl, 0, correctAnswers, 1000);
            animateValue(totalEl, 0, totalQuestions, 1000);
            const successRate = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            animateValue(rateEl, 0, successRate, 1000, true);
            let currentRank = ranks[0]; let nextRank = ranks[1];
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (totalScore >= ranks[i].minScore) {
                    currentRank = ranks[i]; nextRank = ranks[i + 1] || ranks[i]; break;
                }
            }
            levelEl.textContent = currentRank.name;
            const xpForNextLevel = nextRank.minScore - currentRank.minScore;
            const currentXpInLevel = totalScore - currentRank.minScore;
            const xpPercentage = (xpForNextLevel > 0) ? (currentXpInLevel / xpForNextLevel) * 100 : 100;
            setTimeout(() => { xpBar.style.width = `${xpPercentage}%`; }, 500);
        }
        function animateValue(obj, start, end, duration, isPercent = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                obj.innerHTML = isPercent ? `${value}%` : value;
                if (progress < 1) { window.requestAnimationFrame(step); }
            };
            window.requestAnimationFrame(step);
        }
        function generateCertificate() {
            const name = prompt('Ingresa tu nombre para el certificado:', 'Piloto Espacial');
            if (!name) { // Agregamos esta verificación para no mostrar el modal si se cancela el prompt
                certificateModal.classList.add('hidden');
                return; 
            }
            sounds.win.play();
            certNameEl.textContent = name; certLevelEl.textContent = levelEl.textContent;
            certDateEl.textContent = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            certificateModal.classList.remove('hidden');
            setTimeout(() => {
                sounds.prize.play();
                const end = Date.now() + (2 * 1000);
                (function frame() {
                    confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, shapes: ['🏆'], scalar: 2.5 });
                    confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, shapes: ['🏆'], scalar: 2.5 });
                    if (Date.now() < end) { requestAnimationFrame(frame); }
                }());
            }, 500);
        }
        function downloadCertificate() {
            const certificateNode = document.getElementById('certificate');
            html2canvas(certificateNode, { scale: 2, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Certificado-${certNameEl.textContent.trim()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                console.error("Error al generar el canvas: ", err);
                alert("Hubo un error al intentar descargar el certificado. Asegúrate de que los logos estén en la ruta correcta (icons/logoUE.png y icons/logoECR.png).");
            });
        }
        generateBtn.addEventListener('click', generateCertificate);
        closeBtn.addEventListener('click', () => certificateModal.classList.add('hidden'));
        downloadBtn.addEventListener('click', downloadCertificate);
        
        loadProgress();
    });
    </script>
</body>
</html>